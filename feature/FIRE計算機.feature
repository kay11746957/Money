# language: zh-TW
Feature: 退休金缺口與投資計算器
  作為想規劃退休的投資人
  我想要計算每月需要投資多少錢才能達成退休目標
  為了確保退休後能維持理想的生活品質

  Background:
    Given 我開啟退休金缺口計算器 "/calculator/fire"
    Then 顯示可愛的載入動畫 (小火箭升空 + "計算你的財務自由之路..." 文字 🔥)
    And 頁面應該載入在 2 秒內
    And 載入完成後動畫淡出

  @UI @InitialState
  Scenario: 初始頁面載入與參數輸入區
    Then 卡片標題顯示 "退休金缺口與投資計算器" 伴隨 emoji 💰
    And 顯示說明文字 "計算每月需要投資多少，才能安心退休"
    And 顯示「基本設定」區塊包含以下輸入欄位:
      | 欄位名稱                     | 類型     | 預設值     | 說明/提示文字                           |
      | 預計退休每月提取金額         | number   | 30000      | "以今日購買力計算，已考慮通膨影響"       |
      | 還有幾年退休                 | number   | 20         | "距離你的退休年齡還有多少年"             |
      | 預計提領年數                 | number   | 30         | "退休後預計的生活年數"                   |
      | 現有資產 (目前的退休金)      | number   | 1000000    | "目前已有的儲蓄或退休金"                 |
      | 投資年化報酬率               | select   | 5%         | 選項: 3%, 4%, 5%, 6%, 7%, 8%, 10%       |
      | 預期通膨率                   | select   | 2%         | 選項: 1%, 2%, 3%, 4%                    |
    And 顯示「勞保年金」區塊 (可展開/收合，預設收合):
      | 欄位名稱                     | 類型     | 預設值     | 說明/提示文字                           |
      | 是否納入勞保年金             | toggle   | 開啟       | "將勞保老年年金納入計算"                |
      | 計算方式                     | radio    | 簡易概算   | 選項: 簡易概算 / 自行輸入                  |
      | 勞保開始領取年齡             | select   | 65         | 選項: 60, 61, 62, 63, 64, 65 歲         |
    And 「勞保年金」區塊旁顯示「勞保局試算連結」按鈕
    And 顯示「勞退金」區塊 (可展開/收合，預設收合):
      | 欄位名稱                     | 類型     | 預設值     | 說明/提示文字                           |
      | 是否納入勞退金               | toggle   | 開啟       | "將勞工退休金納入計算"                  |
      | 預估勞退月領金額             | number   | 10000      | "可至勞退個人專戶查詢試算"              |
      | 勞退開始領取年齡             | select   | 65         | 選項: 60, 61, 62, 63, 64, 65 歲         |
    And 「勞退金」區塊旁顯示「勞退專戶查詢」按鈕
    And 每個欄位有清楚的 label 和說明 icon (hover 顯示詳細解釋)
    And 顯示主要計算按鈕 "計算每月需要投資多少錢？" (紫色大按鈕)

  @UI @LaborInsuranceSimpleCalc
  Scenario: 勞保年金簡易概算模式
    Given 我選擇勞保計算方式為 "簡易概算"
    Then 顯示簡易概算輸入欄位:
      | 欄位名稱                     | 類型     | 預設值     | 說明/提示文字                           |
      | 平均月投保薪資               | select   | 45800      | 勞保投保薪資分級表選項                |
      | 預估投保年資               | number   | 30         | "工作年數，最高採計 45 年"              |
    And 平均月投保薪資下拉選單包含勞保投保薪資分級表 (例如):
      | 薪資分級     |
      | 26,400 元  |
      | 30,300 元  |
      | 33,300 元  |
      | 36,300 元  |
      | 40,100 元  |
      | 45,800 元  |
      | 48,200 元  |
      | 50,600 元  |
      | 53,000 元  |
      | 55,400 元  |
      | 60,800 元  |
      | 63,800 元  |
      | 66,800 元  |
      | 72,800 元  |
      | 76,500 元  |
      | 80,200 元  |
      | 150,000 元 |
    And 顯示「勞保年金簡易試算結果」即時顯示:
      | 項目                       | 說明                                     |
      | 每月預估可領               | 使用公式: 平均薪資 × 年資 × 1.55%        |
      | 計算公式說明               | "勞保 A 式計算 (取較優者)"               |
    And 隨輸入即時更新預估金額 (不需按計算)

  @UI @LaborInsuranceManualInput
  Scenario: 勞保年金自行輸入模式
    Given 我選擇勞保計算方式為 "自行輸入"
    Then 隱藏簡易概算欄位 (平均薪資、年資)
    And 顯示直接輸入欄位:
      | 欄位名稱                     | 類型     | 預設值     | 說明/提示文字                           |
      | 預估勞保月領金額             | number   | 20000      | "已知道精確金額時使用"                  |
    And 顯示提示文字 "建議至勞保局網站進行精確試算"

  @UI @LaborInsuranceFormula
  Scenario: 勞保年金計算公式說明
    When 我點擊「查看計算公式」連結
    Then 顯示公式說明卡片:
      """
      📊 勞保老年年金計算公式
      
      「A 式」: 平均月投保薪資 × 投保年資 × 0.775% × 2
           = 平均月投保薪資 × 投保年資 × 1.55%
      
      「B 式」: 平均月投保薪資 × 投保年資 × 1.55% + 3,000元
      
      ℹ️ 勞保局會自動擇優給付，本計算器採用 A 式簡化計算
      
      ⚠️ 此為概估，實際金額請以勞保局實際核定為準
      """
    And 卡片可收合

  @UI @InfoTooltips
  Scenario: 欄位說明提示
    When 我將滑鼠移到 "預計退休每月提取金額" 旁的 info icon
    Then 顯示 tooltip:
      """
      這是以「今日購買力」計算的金額。
      例如：輸入 30,000 元，代表退休後每月想花相當於
      今日 30,000 元購買力的錢。
      系統會自動考慮通膨，計算實際需要的金額。
      """
    When 我將滑鼠移到 "實質報酬率" 說明區
    Then 顯示 tooltip:
      """
      實質報酬率 = 投資報酬率 - 通膨率
      這是扣除通膨後的真正增值率。
      """

  @UI @LaborInsuranceInfo
  Scenario: 勞保年金欄位說明提示
    When 我將滑鼠移到 "平均月投保薪資" 旁的 info icon
    Then 顯示 tooltip:
      """
      平均月投保薪資是指：
      加保期間最高 60 個月的月投保薪資平均
      
      👉 如不確定，可選擇目前或預期的投保薪資
      """
    When 我將滑鼠移到 "預估投保年資" 旁的 info icon
    Then 顯示 tooltip:
      """
      投保年資是指參加勞保的總年數
      
      ℹ️ 年資越高，年金越高 (最高採計 45 年)
      ℹ️ 每延後 1 年領取，可增加 4% 年金
      """

  @UI @LaborPensionInfo
  Scenario: 勞退金欄位說明提示
    When 我將滑鼠移到 "預估勞退月領金額" 旁的 info icon
    Then 顯示 tooltip:
      """
      勞工退休金 (新制) 包含：
      1. 雇主每月提撒 6%
      2. 個人自願提撒 (0-6%)
      
      可登入勞保局「勞退個人專戶」查詢累積金額
      👉 建議使用勞退試算工具預估
      """

  @UI @LaborInsuranceLinks
  Scenario: 勞保快速試算連結
    When 我點擊「勞保局試算連結」按鈕
    Then 以新分頁開啟勞保局老年給付試算頁面
    And URL: https://www.bli.gov.tw 

  @UI @LaborPensionLinks
  Scenario: 勞退專戶查詢連結
    When 我點擊「勞退專戶查詢」按鈕
    Then 以新分頁開啟勞保局 e 化服務頁面
    And URL: https://edesk.bli.gov.tw

  @Calculation @MainResult
  Scenario: 成功計算每月需投資金額 (含勞保勞退)
    Given 我輸入以下參數:
      | 欄位                       | 值         |
      | 預計退休每月提取金額       | 30000      |
      | 還有幾年退休               | 20         |
      | 預計提領年數               | 30         |
      | 現有資產                   | 1000000    |
      | 投資年化報酬率             | 5%         |
      | 預期通膨率                 | 2%         |
    And 我開啟勞保年金區塊並設定:
      | 欄位                       | 值         |
      | 計算方式                   | 簡易概算     |
      | 平均月投保薪資             | 45800      |
      | 預估投保年資             | 30         |
      | 勞保開始領取年齡           | 65         |
    And 我開啟勞退金區塊並輸入:
      | 欄位                       | 值         |
      | 預估勞退月領金額           | 10000      |
      | 勞退開始領取年齡           | 65         |
    When 我點擊 "計算每月需要投資多少錢？"
    Then 按鈕顯示 loading spinner (0.5s)
    And 結果區塊淡入顯示:
      | 項目                       | 樣式                                     | 說明                           |
      | 每月需投資金額             | 超大字 text-4xl 紫色 + 計數動畫          | 主要結果，最醒目               |
      | 實質報酬率                 | 中字 text-xl 灰色                        | 投資報酬率 - 通膨率            |
      | 退休時所需總資產           | 中字 text-xl                             | 足夠提領 30 年的總金額         |
      | 勞保年金預估總額           | 中字 橘色標示                            | 簡易概算結果                     |
      | 勞退金預估總額             | 中字 黃色標示                            | 30 年共可領取的勞退金額        |
      | 需自行準備資產             | 中字                                     | 總需求 - 勞保 - 勞退            |
      | 現有資產退休時價值         | 中字                                     | 現有 100 萬增值後的金額        |
      | 退休金缺口                 | 紅色標示 (若有缺口)                      | 需要額外累積的金額             |
    And 結果下方顯示計算明細 (可展開/收合)
    And 勞保年金顯示「簡易概算」標籤

  @Calculation @OnlyLaborInsurance
  Scenario: 只納入勞保不納入勞退
    Given 我開啟 "是否納入勞保年金" toggle
    And 我關閉 "是否納入勞退金" toggle
    Then 勞退金相關欄位變成 disabled (灰色)
    And 計算時只包含勞保年金
    And 結果中只顯示「勞保年金預估總額」

  @Calculation @OnlyLaborPension
  Scenario: 只納入勞退不納入勞保
    Given 我關閉 "是否納入勞保年金" toggle
    And 我開啟 "是否納入勞退金" toggle
    Then 勞保年金相關欄位變成 disabled (灰色)
    And 計算時只包含勞退金
    And 結果中只顯示「勞退金預估總額」

  @Calculation @WithoutBothInsurance
  Scenario: 勞保勞退都不納入計算
    Given 我關閉 "是否納入勞保年金" toggle
    And 我關閉 "是否納入勞退金" toggle
    Then 所有勞保勞退欄位變成 disabled (灰色)
    And 計算時不包含任何勞保勞退金額
    And 結果中不顯示勞保勞退相關項目

  @Calculation @LaborInsuranceDelay
  Scenario: 勞保領取年齡晚於退休年齡
    Given 我設定 "還有幾年退休" 為 10 (55 歲退休)
    And 我設定 "勞保勞退開始領取年齡" 為 65
    When 我點擊計算
    Then 顯示提示訊息:
      """
      ⚠️ 注意：你計畫 55 歲退休，但勞保勞退預計 65 歲才開始領取
      退休後的前 10 年需完全依靠自有資產
      """
    And 圖表中標註「無勞保勞退期間」區段 (55-65 歲)
    And 計算結果已考慮此空窗期

  @Calculation @DetailBreakdown
  Scenario: 顯示詳細計算明細 (含勞保勞退)
    Given 計算完成
    When 我點擊 "查看計算明細"
    Then 展開顯示計算過程:
      | 步驟                           | 說明                                     |
      | Step 1: 計算實質報酬率         | 5% - 2% = 3% (年)                        |
      | Step 2: 退休後每年提取金額     | 30,000 × 12 = 360,000 元/年              |
      | Step 3: 退休時所需總資產       | 使用年金現值公式計算 30 年提領           |
      | Step 4: 勞保勞退總額計算       | (20,000 + 10,000) × 12 × 30 = 10,800,000 |
      | Step 5: 需自行準備資產         | 所需總資產 - 勞保勞退總額                |
      | Step 6: 現有資產增值           | 1,000,000 × (1.03)^20                    |
      | Step 7: 退休金缺口             | 需自行準備資產 - 現有資產增值            |
      | Step 8: 每月投資金額           | 使用年金終值公式反推                     |
    And 每個步驟有展開看詳細公式的選項
    And 勞保勞退計算步驟標註「勞保勞退」標籤 (綠色)

  @Calculation @NoGap
  Scenario: 現有資產已足夠的情況
    Given 我輸入現有資產 10000000 (一千萬)
    And 其他參數維持預設值
    When 我點擊計算
    Then 結果顯示:
      | 項目                       | 內容                                     |
      | 每月需投資金額             | 0 元                                     |
      | 狀態                       | 🎉 恭喜！你的現有資產已足夠退休         |
      | 超額資產                   | 顯示多餘的金額 (綠色)                   |
    And 顯示鼓勵訊息卡片 (綠色背景)

  @Calculation @LargeGap
  Scenario: 退休金缺口過大的警示
    Given 計算結果顯示每月需投資金額超過合理範圍 (例如 > 50000)
    Then 結果區顯示黃色警示卡片:
      | 警示內容                                           |
      | "每月投資金額較高，建議考慮以下調整："             |
    And 顯示建議選項:
      | 建議                       | CTA                                     |
      | 降低退休後每月提取金額     | "調整提取金額" 連結 (滑動到該欄位)      |
      | 延後退休年齡               | "增加工作年數" 連結                     |
      | 提高投資報酬率             | "了解投資選項" 連結                     |
      | 增加現有資產               | 提示一次性投入的效果                    |

  @Chart @Visualization
  Scenario: 資產成長與消耗視覺化圖表
    Given 計算完成
    Then 顯示雙區段折線圖:
      | 區段                       | 說明                                     |
      | 累積期 (左半)              | 從現在到退休的資產成長曲線 (藍色)        |
      | 提領期 (右半)              | 退休後資產遞減曲線 (橘色)               |
    And 圖表標註:
      | 標註點                     | 說明                                     |
      | 退休年                     | 垂直虛線標示退休時間點                   |
      | 最高資產點                 | 退休時的總資產金額                       |
      | 資產歸零點                 | 預計提領完畢的時間點                     |
    And hover 顯示每年詳細金額
    And 圖表下方顯示年份軸 (1, 5, 10... 50 年)

  @Chart @PieChart
  Scenario: 退休金組成圓餅圖
    Given 計算完成
    Then 顯示圓餅圖呈現退休金來源:
      | 來源                       | 顏色     | 說明                         |
      | 勞保年金                   | 橘色     | 勞保老年年金預估總額         |
      | 勞退金                     | 黃色     | 勞工退休金預估總額           |
      | 現有資產增值               | 藍色     | 100萬增值到退休時的金額      |
      | 未來投資累積               | 紫色     | 每月定投累積的金額           |
      | 投資收益                   | 綠色     | 複利效果產生的收益           |
    And hover 顯示各部分金額和百分比
    And 勞保勞退部分合計顯示「政府保障」標籤

  @Validation @ErrorHandling
  Scenario Outline: 輸入驗證
    When 我將 "<欄位>" 輸入 "<無效值>"
    Then "<欄位>" 下方顯示錯誤訊息 "<錯誤訊息>"
    And 計算按鈕變成 disabled

    Examples:
      | 欄位                     | 無效值 | 錯誤訊息                       |
      | 預計退休每月提取金額     | 0      | 提取金額必須大於 0             |
      | 預計退休每月提取金額     | -5000  | 提取金額必須大於 0             |
      | 還有幾年退休             | 0      | 至少需要 1 年以上的規劃時間    |
      | 還有幾年退休             | 51     | 最長規劃期間為 50 年           |
      | 預計提領年數             | 0      | 提領年數至少 1 年              |
      | 現有資產                 | -100   | 資產金額不能為負數             |

  @Validation @RateValidation
  Scenario: 報酬率低於通膨率警示
    Given 我選擇投資報酬率 3%
    And 我選擇通膨率 4%
    Then 顯示警示訊息 "投資報酬率低於通膨率，資產實質購買力會下降"
    And 實質報酬率顯示為負數 (紅色)

  @Interactive @Slider
  Scenario: 參數滑桿即時調整
    Given 計算完成並顯示結果
    When 我拖動 "投資年化報酬率" 滑桿從 5% 到 7%
    Then 結果區即時更新 (不需重新點擊計算)
    And 圖表動態重繪
    And 顯示報酬率變化對結果的影響差異

  @Scenario @Comparison
  Scenario: 不同情境比較
    Given 計算完成
    When 我點擊 "情境比較" 按鈕
    Then 顯示三欄比較:
      | 情境           | 說明                                     |
      | 保守型         | 報酬率 4%, 通膨 3%                       |
      | 標準型         | 報酬率 6%, 通膨 2% (目前設定)            |
      | 積極型         | 報酬率 8%, 通膨 2%                       |
    And 每個情境顯示對應的每月投資金額
    And 用長條圖視覺化比較差異

  @RWD @Mobile
  Scenario: 手機版響應式設計
    Given 我用手機尺寸 (375x667) 瀏覽
    Then 輸入欄位佔滿寬度，垂直排列
    And 結果金額超大字體居中顯示
    And 圖表可水平滑動查看
    And 計算按鈕 sticky 在底部
    And 展開明細使用全螢幕 modal
    And 情境比較變成可左右滑動的卡片

  @Accessibility
  Scenario: 無障礙支援
    Then 所有輸入欄位有 aria-label
    And 結果金額有 aria-live="polite" 即時播報
    And 錯誤訊息有 role="alert"
    And 圖表有文字摘要說明 (供螢幕閱讀器)
    And 支援鍵盤操作 (Tab, Enter)

  @Education @FinancialLiteracy
  Scenario: 理財知識小卡
    Then 頁面底部顯示教育內容卡片:
      | 標題                       | 內容                                     |
      | 什麼是實質報酬率？         | 扣除通膨後的真正投資收益                 |
      | 72 法則                    | 72 ÷ 報酬率 = 資產翻倍年數              |
      | 為什麼要及早開始？         | 複利效果，早 10 年開始差很多             |
      | 勞保年金怎麼算？           | 計算公式與請領條件說明                   |
      | 勞退新制是什麼？           | 雇主提撥 6% + 個人自願提撥說明           |
      | 勞保 vs 勞退有什麼不同？   | 兩種制度的差異與領取方式                 |
    And 每張卡片可展開看詳細說明
