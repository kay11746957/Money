@{
    ViewData["Title"] = "ETF æ­·å²å›æ¸¬æ¯”è¼ƒ";
}

<div class="backtest-page">
    <div class="container py-5">
        <div id="app">
            <div class="text-center mb-5">
                <h1 class="h2 mb-3">ğŸ“Š ETF æ­·å²å›æ¸¬æ¯”è¼ƒ</h1>
                <p class="text-muted">æ¯”è¼ƒå°è‚¡èˆ‡ç¾è‚¡ ETF çš„æ­·å²ç¸¾æ•ˆï¼Œåšå‡ºæ›´å¥½çš„æŠ•è³‡æ±ºç­–</p>
            </div>
            <!-- å›æ¸¬æ¨¡å¼åˆ‡æ› -->
            <div id="backtest-mode" class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="backtest-mode" id="mode-compare" 
                               value="compare" v-model="backtestMode" data-mode="compare">
                        <label class="btn btn-outline-primary" for="mode-compare">
                            ğŸ“Š ETF æ¯”è¼ƒ
                        </label>

                        <input type="radio" class="btn-check" name="backtest-mode" id="mode-portfolio" 
                               value="portfolio" v-model="backtestMode" data-mode="portfolio">
                        <label class="btn btn-outline-primary" for="mode-portfolio">
                            ğŸ’¼ æŠ•è³‡çµ„åˆ
                        </label>
                    </div>
                </div>
            </div>

            <!-- ETF é¸æ“‡å€å¡Š -->
            <div id="etf-selection" class="card shadow-sm mb-4" v-show="backtestMode === 'compare'">
                <div class="card-body">
                    <h5 class="card-title mb-4">é¸æ“‡è¦æ¯”è¼ƒçš„ ETF</h5>
                    
                    <!-- ETF æœå°‹æ¡† -->
                    <div class="mb-3">
                        <label for="etf-search" class="form-label">æœå°‹ ETF</label>
                        <div class="position-relative">
                            <input 
                                type="text" 
                                id="etf-search" 
                                class="form-control form-control-lg"
                                placeholder="è¼¸å…¥ä»£ç¢¼æˆ–åç¨±æœå°‹..."
                                v-model="searchQuery"
                                v-on:focus="showDropdown = true"
                                autocomplete="off"
                            >
                            <!-- æœå°‹çµæœä¸‹æ‹‰é¸å–® -->
                            <div v-if="showDropdown && filteredEtfs.length > 0" class="etf-dropdown">
                                <div class="etf-group" v-if="filteredTwEtfs.length > 0">
                                    <div class="etf-group-header">ğŸ‡¹ğŸ‡¼ å°è‚¡ ETF</div>
                                    <div 
                                        v-for="etf in filteredTwEtfs" 
                                        :key="etf.symbol"
                                        class="etf-option"
                                        v-on:click="selectEtf(etf)"
                                    >
                                        <span class="etf-symbol">{{ etf.symbol }}</span>
                                        <span class="etf-name">{{ etf.name }}</span>
                                    </div>
                                </div>
                                <div class="etf-group" v-if="filteredUsEtfs.length > 0">
                                    <div class="etf-group-header">ğŸ‡ºğŸ‡¸ ç¾è‚¡ ETF</div>
                                    <div 
                                        v-for="etf in filteredUsEtfs" 
                                        :key="etf.symbol"
                                        class="etf-option"
                                        v-on:click="selectEtf(etf)"
                                    >
                                        <span class="etf-symbol">{{ etf.symbol }}</span>
                                        <span class="etf-name">{{ etf.name }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å·²é¸æ“‡çš„ ETF -->
                    <div class="selected-etfs mt-4">
                        <label class="form-label">å·²é¸æ“‡çš„ ETF</label>
                        <div class="d-flex flex-wrap gap-2">
                            <span 
                                v-for="etf in selectedEtfs" 
                                :key="etf.symbol"
                                class="selected-etf badge bg-primary fs-6 d-flex align-items-center gap-2"
                            >
                                {{ etf.symbol }} - {{ etf.name }}
                                <button type="button" class="btn-close btn-close-white" v-on:click="removeEtf(etf)"></button>
                            </span>
                        </div>
                        <div v-if="selectedEtfs.length === 0" class="text-muted">
                            å°šæœªé¸æ“‡ä»»ä½• ETF
                        </div>
                    </div>
                </div>
            </div>

            <!-- æŠ•è³‡çµ„åˆè¨­å®šå€å¡Š -->
            <div id="portfolio-config" class="card shadow-sm mb-4" v-show="backtestMode === 'portfolio'">
                <div class="card-body">
                    <h5 class="card-title mb-4">æŠ•è³‡çµ„åˆè¨­å®š</h5>
                    
                    <div class="alert alert-info">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong> æŠ•è³‡çµ„åˆæ¨¡å¼å¯ä»¥è¨­å®šå„ ETF çš„é…ç½®æ¯”ä¾‹ï¼Œè¨ˆç®—åŠ æ¬Šå¹³å‡ç¸¾æ•ˆ
                    </div>

                    <!-- çµ„åˆæˆåˆ†åˆ—è¡¨ -->
                    <div v-for="(item, index) in portfolioItems" :key="index" class="portfolio-item mb-3">
                        <div class="row align-items-center g-2">
                            <div class="col-md-5">
                                <select class="form-select" v-model="item.symbol">
                                    <option value="">é¸æ“‡ ETF</option>
                                    <option v-for="etf in etfList" :key="etf.symbol" :value="etf.symbol">
                                        {{ etf.symbol }} - {{ etf.name }}
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="number" class="form-control" v-model.number="item.weight" 
                                           min="1" max="100" placeholder="æ¯”ä¾‹">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-danger btn-sm" v-on:click="removePortfolioItem(index)" 
                                        v-if="portfolioItems.length > 1">
                                    ç§»é™¤
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <button class="btn btn-outline-primary btn-sm" v-on:click="addPortfolioItem"
                                v-bind:disabled="portfolioItems.length >= 5">
                            + æ–°å¢ ETF
                        </button>
                        <span :class="totalWeight === 100 ? 'text-success' : 'text-danger'">
                            ç¸½é…ç½®: {{ totalWeight }}%
                        </span>
                    </div>
                </div>
            </div>

            <!-- å›æ¸¬åƒæ•¸å€å¡Š -->
            <div id="backtest-params" class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-4">å›æ¸¬åƒæ•¸è¨­å®š</h5>
                    
                    <div class="row g-3">
                        <!-- å›æ¸¬æœŸé–“ -->
                        <div class="col-md-4">
                            <label for="backtest-period" class="form-label">å›æ¸¬æœŸé–“</label>
                            <select id="backtest-period" class="form-select" v-model="params.period">
                                <option value="1">1 å¹´</option>
                                <option value="3">3 å¹´</option>
                                <option value="5">5 å¹´</option>
                                <option value="10">10 å¹´</option>
                                <option value="20">20 å¹´</option>
                            </select>
                        </div>

                        <!-- æŠ•è³‡æ–¹å¼ -->
                        <div class="col-md-4">
                            <label for="investment-mode" class="form-label">æŠ•è³‡æ–¹å¼</label>
                            <select id="investment-mode" class="form-select" v-model="params.investmentMode">
                                <option value="dca">å®šæœŸå®šé¡</option>
                                <option value="lumpsum">å–®ç­†æŠ•å…¥</option>
                            </select>
                        </div>

                        <!-- æŠ•è³‡é‡‘é¡ -->
                        <div class="col-md-4">
                            <label for="investment-amount" class="form-label">
                                {{ params.investmentMode === 'dca' ? 'æ¯æœˆæŠ•å…¥é‡‘é¡' : 'å–®ç­†æŠ•å…¥é‡‘é¡' }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">NT$</span>
                                <input 
                                    type="number" 
                                    id="investment-amount" 
                                    class="form-control" 
                                    v-model.number="params.amount"
                                    min="1000"
                                    step="1000"
                                >
                            </div>
                        </div>
                    </div>

                    <!-- é…æ¯å†æŠ•å…¥é¸é … -->
                    <div class="form-check mt-3">
                        <input 
                            type="checkbox" 
                            id="reinvest-dividends" 
                            class="form-check-input"
                            v-model="params.reinvestDividends"
                        >
                        <label for="reinvest-dividends" class="form-check-label">
                            é…æ¯å†æŠ•å…¥
                        </label>
                    </div>

                    <!-- é–‹å§‹å›æ¸¬æŒ‰éˆ• -->
                    <div class="mt-4">
                        <button 
                            id="start-backtest"
                            class="btn btn-primary btn-lg"
                            v-on:click="startBacktest"
                            v-bind:disabled="selectedEtfs.length === 0 || loading"
                        >
                            <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                            {{ loading ? 'è¨ˆç®—ä¸­...' : 'ğŸš€ é–‹å§‹å›æ¸¬' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- çµæœå€å¡Š -->
            <div id="backtest-result" v-if="result && result.results.length > 0" class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">ğŸ“Š å›æ¸¬çµæœ</h5>
                        <button id="share-button" class="btn btn-outline-primary btn-sm" v-on:click="shareResult">
                            ğŸ“¤ åˆ†äº«çµæœ
                        </button>
                    </div>
                    
                    <!-- çµæœå¡ç‰‡ -->
                    <div class="row g-4">
                        <div v-for="(r, index) in result.results" :key="r.symbol" class="col-md-6">
                            <div class="result-card" :class="{ 'winner': isWinner(r) }">
                                <div class="result-header">
                                    <span class="etf-badge">{{ r.symbol }}</span>
                                    <span class="etf-label">{{ r.name }}</span>
                                    <span v-if="isWinner(r)" class="winner-badge">ğŸ† å‹å‡º</span>
                                </div>
                                
                                <div class="result-body">
                                    <div class="result-main">
                                        <div class="result-metric">
                                            <span class="metric-label">æœ€çµ‚è³‡ç”¢åƒ¹å€¼</span>
                                            <span class="metric-value">{{ formatCurrency(r.finalValue) }}</span>
                                        </div>
                                        <div class="result-metric highlight">
                                            <span class="metric-label">ç¸½å ±é…¬ç‡</span>
                                            <span class="metric-value" :class="r.totalReturnPercent >= 0 ? 'positive' : 'negative'">
                                                {{ r.totalReturnPercent >= 0 ? '+' : '' }}{{ r.totalReturnPercent }}%
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="result-details">
                                        <div class="detail-item">
                                            <span class="detail-label">ç¸½æŠ•å…¥æœ¬é‡‘</span>
                                            <span class="detail-value">{{ formatCurrency(r.totalInvested) }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">å¹´åŒ–å ±é…¬ç‡ (CAGR)</span>
                                            <span class="detail-value">{{ r.cagr }}%</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">æœ€å¤§å›æ’¤</span>
                                            <span class="detail-value text-danger">-{{ r.maxDrawdown }}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç¸¾æ•ˆèµ°å‹¢åœ– -->
                    <div class="mt-4 pt-4 border-top">
                        <h6 class="mb-3">ğŸ“ˆ ç´¯ç©å ±é…¬èµ°å‹¢</h6>
                        <div class="chart-container">
                            <canvas id="performance-chart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç„¡çµæœæ™‚çš„æç¤º -->
            <div v-if="!result || result.results.length === 0" class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <p class="text-muted mb-0">é¸æ“‡ ETF å¾Œé»æ“Šã€Œé–‹å§‹å›æ¸¬ã€æŸ¥çœ‹çµæœ</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.etf-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
}

.etf-group-header {
    padding: 0.5rem 1rem;
    background: #f8f9fa;
    font-weight: 600;
    font-size: 0.85rem;
    color: #6c757d;
    border-bottom: 1px solid #dee2e6;
}

.etf-option {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: background 0.15s;
    display: flex;
    gap: 0.75rem;
}

.etf-option:hover {
    background: #e9ecef;
}

.etf-symbol {
    font-weight: 600;
    color: #7c3aed;
    min-width: 70px;
}

.etf-name {
    color: #495057;
}

.selected-etf {
    padding: 0.5rem 0.75rem;
}

.selected-etf .btn-close {
    font-size: 0.6rem;
}

/* Result Card Styles */
.result-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 1px solid #e9ecef;
    border-radius: 1rem;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.result-card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.result-card.winner {
    border-color: #10b981;
    background: linear-gradient(135deg, #ecfdf5 0%, #ffffff 100%);
}

.result-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
    flex-wrap: wrap;
}

.etf-badge {
    background: linear-gradient(135deg, #7c3aed, #a855f7);
    color: white;
    padding: 0.375rem 0.75rem;
    border-radius: 0.5rem;
    font-weight: 700;
    font-size: 0.9rem;
}

.etf-label {
    color: #6b7280;
    font-size: 0.9rem;
}

.winner-badge {
    background: #10b981;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: auto;
}

.result-main {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e9ecef;
}

.result-metric {
    text-align: center;
}

.metric-label {
    display: block;
    font-size: 0.8rem;
    color: #6b7280;
    margin-bottom: 0.25rem;
}

.metric-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
}

.metric-value.positive {
    color: #10b981;
}

.metric-value.negative {
    color: #ef4444;
}

.result-details {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.detail-label {
    font-size: 0.85rem;
    color: #6b7280;
}

.detail-value {
    font-weight: 600;
    color: #374151;
}
</style>

@section Scripts {
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="~/js/backtest-calculator.js" asp-append-version="true"></script>
}
